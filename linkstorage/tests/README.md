# Тестирование проекта LinkStorage

## Общая информация

В проекте реализована система автоматических тестов для проверки корректности работы API, бизнес-логики, безопасности и валидации данных. Тесты написаны с использованием **pytest** и **httpx** (асинхронные запросы к FastAPI).

---

## Как запускать тесты

**Локально:**
```bash
pytest --cov=app
```

**В Docker:**
```bash
docker-compose run --rm web pytest --cov=app
```

**Запуск одного файла или теста:**
```bash
pytest tests/test_auth.py -k test_register_and_login
```

---

## Структура тестов

- **test_auth.py** — регистрация, аутентификация, сброс и смена пароля, работа с токенами.
- **test_collections.py** — CRUD-операции с коллекциями.
- **test_links.py** — CRUD-операции со ссылками.
- **test_users.py** — информация о пользователе, смена пароля.
- **test_link_parser.py** — парсинг метаданных ссылок.
- **test_security.py** — безопасность, авторизация, доступ к защищённым эндпоинтам.
- **test_deep.py** — "глубокие" тесты: безопасность, уникальность, XSS/SQL-инъекции, обязательность полей, попытки доступа к чужим данным.
- **test_models_and_schemas.py** — тесты моделей и схем Pydantic.
- **test_sample.py** — примеры и шаблоны для новых тестов.

---

## Что проверяют тесты

### 1. Позитивные сценарии
- Успешная регистрация, вход, создание/удаление ссылок и коллекций, смена пароля.
- Получение информации о пользователе, получение списка и одной ссылки/коллекции.

### 2. Негативные сценарии
- Попытка регистрации с существующим email.
- Вход с неверным паролем.
- Сброс пароля с невалидным или истёкшим токеном.
- Попытка добавить дубликат ссылки.
- Попытка создать коллекцию без обязательных полей.
- Попытка получить/удалить чужие данные.
- Повторное использование токена сброса пароля.

### 3. Пограничные случаи
- Отсутствие обязательных полей.
- Попытка добавить ссылку с XSS/SQL-инъекцией в url.
- Попытка добавить ссылку с некорректным url.
- Попытка сбросить пароль для несуществующего email.

### 4. Безопасность
- Невозможность сбросить чужой пароль.
- Невозможность получить/удалить чужие ссылки.
- Защита от XSS/SQL-инъекций в url.
- Проверка авторизации для защищённых эндпоинтов.

---

## Как добавлять новые тесты

1. Создайте новый файл в папке `tests/` или добавьте тест в существующий по тематике.
2. Используйте `pytest.mark.asyncio` для асинхронных тестов.
3. Для интеграционных тестов используйте `AsyncClient` и `ASGITransport` из httpx.
4. Покрывайте как позитивные, так и негативные сценарии.
5. Проверяйте коды ответов, сообщения об ошибках и бизнес-логику.
6. Для тестов безопасности моделируйте атаки (XSS, SQL-инъекции, попытки доступа к чужим данным).
7. Для unit-тестов моделей и схем используйте простые вызовы функций и проверку валидации.

---

## Рекомендации по тестированию

- **Покрытие кода:** Стремитесь к 100% покрытию, но не забывайте про сложные сценарии и безопасность.
- **Изоляция:** Каждый тест должен быть независимым (используйте уникальные email/данные).
- **Чистота данных:** Тестовые данные не должны мешать друг другу (используйте tmp_path, уникальные значения).
- **Документирование:** Описывайте, что проверяет каждый тест (docstring).
- **CI/CD:** Рекомендуется запускать тесты автоматически при каждом коммите/мерже (например, через GitHub Actions).

---

## Контакты и вопросы

Если вы нашли баг или хотите предложить новый тест — создайте issue или pull request.

---

**Поддерживайте тесты в актуальном состоянии при изменении бизнес-логики!** 